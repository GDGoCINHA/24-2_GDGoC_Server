name: CI

on:
  pull_request:
    branches: [ "develop", "main" ]
    types: [ opened, synchronize, reopened, ready_for_review ]
  workflow_dispatch: {}

permissions:
  contents: read
  checks: write
  pull-requests: write
  issues: write

concurrency:
  group: pr-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: 17 }
      - uses: gradle/actions/setup-gradle@v3
        if: ${{ !env.ACT }}
        with:
          cache-read-only: ${{ github.event_name == 'pull_request' }}
          gradle-home-cache-cleanup: true

      - name: Create dummy .env for CI
        working-directory: gdgoc
        run: echo "# ci dummy" > .env

      - name: Gradle build (skip tests)
        id: assemble
        working-directory: gdgoc
        env: { GRADLE_OPTS: "-Dorg.gradle.vfs.watch=false" }
        run: |
          chmod +x ./gradlew
          ./gradlew build -x test --no-daemon --stacktrace --info --no-watch-fs | tee ../build.log

      - name: Gradle test (H2 in-memory)
        id: test
        working-directory: gdgoc
        continue-on-error: true
        env:
          GRADLE_OPTS: "-Dorg.gradle.vfs.watch=false"
          SPRING_PROFILES_ACTIVE: test
          SPRING_DATASOURCE_URL: jdbc:h2:mem:ci;MODE=PostgreSQL;DB_CLOSE_DELAY=-1;DATABASE_TO_LOWER=TRUE
          SPRING_DATASOURCE_USERNAME: sa
          SPRING_DATASOURCE_PASSWORD: ""
          SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.h2.Driver
          SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.H2Dialect
          SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop
        run: ./gradlew test --no-daemon --stacktrace --info --no-watch-fs | tee ../test.log
